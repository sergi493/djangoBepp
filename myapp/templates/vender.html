



    {% load static %}
     
    {% block content %}
    {% include "buscar_cliente.html" %}
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Tienda</title>
        <style>
            table img{
                max-width: 40px;
                height:auto;
                border-radius:5px;
                
            }
            #botoClient{
                display:;
            }
            
        </style>

        
    
    <script src="https://kit.fontawesome.com/8e16281abb.js" crossorigin="anonymous"></script>
    </head>
    <body>
    
        <div class="main-content">
            <div class="products-section">
                <h1>PUNT DE VENDA</h1>
                
                <input type="text" id="searchProducto" placeholder="Buscar producte...">
                
                <script>
                    var cestaProductos = [];
                </script>


                <table id="productTable">

                    <thead>
                        <tr>
                            <th>Foto</th>
                            <th>Nom</th>
                            <th>Referencia</th>
                            <th>Quantitat</th>
                            <th>Descripcio</th>
                            <th>Preu</th>
                            <th>Acció</th>
                        </tr>
                    </thead>
                    <tbody id="tbody_prod">


                    
                    


                        
                    </form>
                    </tbody>


               
                    </tbody> 
                </table>
                <div id="paginationProducto"></div>
            </div>
            <div class="cart-section">
                <h1>CISTELL</h1>
                <div class="cesta">
                    
                    <div class="toggle-container">
                        <p>Ticket:<span id="ticket-number" style="display:none;"></span></p>
    <div class="toggle-switch">
        <input type="checkbox" id="switch" />
        <label for="switch"></label>
    </div>
    <p>Factura:<span id="factura-number" style="display:none;"></span></p>

    <p class="datos-client"  id="datos-client">
        ID: <span id="clientIdSelCrear"> </span>
        Nom: <span id="clientNomSelCrear"> </span> 
        DNI: <span id="clientNifSelCrear"> </span> 
        TLF: <span id="clientTelSelCrear"> </span> 
        LOC: <span id="clientLocalSelCrear"> </span></p>

        <script>
            
document.addEventListener("DOMContentLoaded", () => {
           const input = document.getElementById("searchProducto");
    const tbody = document.getElementById("tbody_prod");
            const pagination = document.getElementById("paginationProducto");
            let currentPage = 1;

    function fetchProductos(page = 1) {
        const texto = input.value.trim();
                currentPage = page;

        fetch("{% url 'buscar_producto' %}", {
            method: "POST",
            headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: new URLSearchParams({ texto, page })
                })
                .then(res => res.json())
                .then(data => {
                    tbody.innerHTML = "";

                    if (data.productos && data.productos.length > 0) {
                        data.productos.forEach(producto => {
                        const fila = document.createElement("tr");
                        fila.id = `producto-${producto.id}`;           // Para tu importarProducto(id)
                        fila.innerHTML = `
                            <td><img src="${producto.imagen}"/></td>
                            <td>${producto.nombre}</td>
                        <td>${producto.codigo}</td>
                        <td>
                            ${ producto.cantidad }
                            
                        </td>   
                        <td>${ producto.descripcion }</td>
                    <td>${ producto.precio } €</td>
                       <td><button type="button" class="popup-trigger" onclick="botonAñadirCarta(event)"><i
                        class="fa-regular fa-pen-to-square"></i></button></td>`;
                        tbody.appendChild(fila);
                        });

                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="8" style="text-align:center; font-style:italic;">
                                    No se encontraron clientes
                                </td>
                            </tr>`;
                    }

                    renderPagination(data.page_info);
                })
                .catch(err => {
                    console.error("Error al buscar clientes:", err);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align:center; color:red;">
                                Error al buscar clientes
                            </td>
                        </tr>`;
                    pagination.innerHTML = "";
                });
            }

            function renderPagination({ current, total, has_prev, has_next }) {
                pagination.innerHTML = "";

                if (has_prev) {
                    const prevBtn = document.createElement("button");
                    prevBtn.textContent = "« Anterior";
                    prevBtn.onclick = () => fetchProductos(current - 1);
                    pagination.appendChild(prevBtn);
                }

                const info = document.createElement("span");
                info.textContent = ` Página ${current} de ${total} `;
                pagination.appendChild(info);

                if (has_next) {
                    const nextBtn = document.createElement("button");
                    nextBtn.textContent = "Siguiente »";
                    nextBtn.onclick = () => fetchProductos(current + 1);
                    pagination.appendChild(nextBtn);
                }
            }

            fetchProductos();
            input.addEventListener("input", () => fetchProductos(1));
        });

        






            document.addEventListener('DOMContentLoaded', function() {
                var switchElement = document.getElementById('switch');
                var datosClient = document.getElementById('datos-client');
                var botoClient = document.getElementById('mostrarPopup');
                var botoFacturar = document.getElementById('botoFacturar');
                var botoTicket = document.getElementById('botoTicket');
                // Verificació inicial
                if (switchElement.checked) {
                    datosClient.style.display = 'block';
                    botoClient.style.display = 'block';
                    botoTicket.style.display = 'none';
                    botoFacturar.style.display = 'block';
                } else {
                    datosClient.style.display = 'none';
                    botoClient.style.display = 'none';
                    botoTicket.style.display = 'block';
                    botoFacturar.style.display = 'none';
                }
            
                // Event listener per canvis en el switch
                switchElement.addEventListener('change', function() {
                    if (this.checked) {
                        datosClient.style.display = 'block';
                        botoClient.style.display = 'block';
                        botoTicket.style.display = 'none';
                    botoFacturar.style.display = 'block';
                    } else {
                        datosClient.style.display = 'none';
                        botoClient.style.display = 'none';
                        botoTicket.style.display = 'block';
                    botoFacturar.style.display = 'none';
                    }
                });
            });
        </script>                     
                        
                        
                        
                        <button onclick="showOverlay()" id="mostrarPopup">Client</button>
                        
                    </div>
                    
                    <script>
                        document.addEventListener('DOMContentLoaded', (event) => {
                            const switchElement = document.getElementById('switch');
                            const textElement = document.getElementByClass('datos-cliente');
                        
                            // Función para actualizar la visibilidad del texto
                            const updateTextVisibility = () => {
                                if (switchElement.checked) {
                                    textElement.style.display = 'block';
                                } else {
                                    textElement.style.display = 'none';
                                }
                            };
                        
                            // Escuchar cambios en el checkbox
                            switchElement.addEventListener('change', updateTextVisibility);
                        
                            // Actualizar la visibilidad inicial
                            updateTextVisibility();
                        });
                    </script>
                        <style>
                           
                            
                        </style>
                    
                        <hr>
                        <table id="cart">
                            <thead>
                                <tr>
                                    <th>Cod.</th>
                                    <th>Produc.</th>
                                    <th>Preu</th>
                                    <th>-</th>
                                    <th>Quant.</th>
                                    <th>+</th>
                                    <th>Total</th>
                                    <th>Eliminar</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Los elementos de la tabla se generarán dinámicamente aquí -->
                            </tbody>
                        </table>
                        <hr>
                        <div class="cart-options">
                            <p>Total: <span id="total"></span> €</p>
                        <div class="ef">
                            <label>Efectiu: </label>
                            <input type="number" id="Efectivo" placeholder="50€">
                        </div>
                        <form id="FormTipusPagament">
                            <label for="checkbox0">Targeta</label>
                            <input value="Targeta" type="checkbox" id="checkbox0" name="pagament">
                            
                            <label for="checkbox1">Efectiu</label>
                            <input value="Efectiu" type="checkbox" id="checkbox1" name="pagament">
                            
                            <label for="checkbox2">Transferencia</label>
                            <input value="Transferencia" type="checkbox" id="checkbox2" name="pagament">
                            
                            <label for="checkbox3">Chec bancari</label>
                            <input value="Chec bancari" type="checkbox" id="checkbox3" name="pagament">
                            
                            <label for="checkbox4">domiciliació</label>
                            <input value="Domiciliacio" type="checkbox" id="checkbox4" name="pagament">
                            
                        
                        </form>
                        
                        <script>
                            // Función para manejar el cambio en el checkbox
                            document.getElementById('checkbox').addEventListener('change', function() {
                                var efDiv = document.querySelector('.ef');
                                var cambioParagraph = document.querySelector('#cambio').parentNode; // Obtener el párrafo que contiene el texto "CAMBIO"
                        
                                // Si el checkbox está marcado, ocultar el div "ef" y el párrafo del cambio
                                if (this.checked) {
                                    efDiv.style.display = 'none';
                                    cambioParagraph.style.display = 'none';
                                } else { // Si no está marcado, mostrar el div "ef" y el párrafo del cambio
                                    efDiv.style.display = 'block';
                                    cambioParagraph.style.display = 'block';
                                }
                            });
                        </script>
                        <style>
                            .botoTicketFactura{
                                align-items: center;
                                display:flex;
                                justify-content:center;
                                
                            }                    </style>
                        
                        <p>CANVI: <span id="cambio"></span></p>
                        <div class="botoTicketFactura">
                        <button  id="botoFacturar" onclick="genFactura()">FACTURAR (Imprimir + Guardar + Buidar cistell)</button>
        <button id="botoTicket" class="cart-button" onclick="genTicketYEnviar()"> TICKET DE VENTA (Imprimir + Guardar + Buidar cistell)</button>
                    </div>
                        <script>
                            // Función para calcular el cambio
                            function calcularCambio() {
                                // Obtenemos el valor total y el efectivo introducido
                            // Obtener el contenido del elemento 'total'
                                var total = document.getElementById('total').textContent;

    // Eliminar el símbolo de dólar del principio y luego convertir la cadena a un número de punto flotante

                                var efectivo = parseFloat(document.getElementById('Efectivo').value);
                                
                                // Mensajes de depuración
                                console.log("Total:", total);
                                console.log("Efectivo:", efectivo);
                                
                                // Verificamos si los valores son números válidos
                                if (isNaN(total) || isNaN(efectivo)) {
                                    console.log("Al menos uno de los valores no es un número válido.");
                                    document.getElementById('cambio').textContent = '';
                                    return;
                                }
                                
                                // Calculamos el cambio
                                var cambio = total - efectivo;
                                
                                // Mostramos el resultado en el span con el id "cambio"
                                document.getElementById('cambio').textContent = cambio.toFixed(2);
                            }
                            
                            // Escuchamos el evento input del campo de efectivo
                            document.getElementById('Efectivo').addEventListener('input', calcularCambio);
                        </script>
                        
                        
                        
                        </div>
                </div>
            <hr>
            


<script>






        

    </script>

        <style>
            body{
                color: #000000;
                text-align:center;
            }
            
        
            
            
            .popup {
                position: absolute;
            top: 50%;
            left: 53%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width:80%;
            display:flex;
            }
            
            .izq {
                flex: 1;
                
                max-width:20%;
            }
            
            .dret {
                flex: 1;
            
            }
            
            .popup h1 {
                text-align: center;
            }
            
            .popup p {
                margin-top: 0;
            }
            
            .popup input[type="text"] {
                width: 100%;
                padding: 5px;
                margin-bottom: 5px;
            }
            
            .popup label {
                display: block;
            }
            
        
            
            #searchInput {
                width: 85%;
                padding: 10px;
                margin-bottom: 10px;
                align-items: center;
                margin-left:30px;
            }
            
            #productTable {
                width: 100%;
                border-collapse: collapse;
                
            }
            
            
            #productTable th,
            #productTable td {
                border: 3px solid #ddd;
                padding: 8px;
                text-align: center;
                
            }
            
            #productTable th {
                background-color: black;
            }
            
            button{
                display: inline-block;
                border: none;
                border-radius: 50px;
                border: 1px solid black;
                background:white;
                padding:1%;
                margin-top:5px;
                
            }
            .cesta{
                border:2px solid black;
                border-radius:15px;
                padding: 1%;
                background:grey;
                backdrop-filter:blur(50px);
            }
            .overlay{
                display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            }
        </style>
            
        </div>
        
    </div>
    <script>
        
        
        



        



        
    function updateTotal() {
        var cart = document.getElementById('cart');
        var cartRows = cart.querySelectorAll('tbody tr');
        var totalPrice = 0;

        cartRows.forEach(function(cartRow) {
            var quantity = parseInt(cartRow.querySelector('.quantity').innerText);
            var price = parseFloat(cartRow.querySelector('.price').innerText);
            var itemTotalPrice = quantity * price;
            totalPrice += itemTotalPrice;
        });

        document.getElementById('total').innerText = totalPrice.toFixed(2);
    }

    function updateCartQuantity(action, productName) {
        var cart = document.getElementById('cart');
        var cartRow = cart.querySelector(`tbody tr[data-product="${productName}"]`);
        var quantityElement = cartRow.querySelector('.quantity');
        var quantity = parseInt(quantityElement.innerText);
        var priceElement = cartRow.querySelector('.price');
        var price = parseFloat(priceElement.innerText);
        var subtotalElement = cartRow.querySelector('.subtotal');

        if (action === 'increase') {
            quantity++;
        } else if (action === 'decrease') {
            quantity--;
            /*if (quantity === 0) {
                cartRow.remove();
            }*/
        }

        //if (quantity > 0) {
            quantityElement.innerText = quantity;
            subtotalElement.innerText = (quantity * price).toFixed(2);
            updateTotal();
            calcularCambio();
    // }
    }

    function addToCart(productName, productPrice, productCode) {
        var cart = document.getElementById('cart');
        var existingCartItem = cart.querySelector(`tbody tr[data-product="${productName}"]`);
        if (existingCartItem) {
            updateCartQuantity('increase', productName);
        } else {
            var newRow = document.createElement('tr');
            newRow.setAttribute('data-product', productName);
            newRow.innerHTML = `
                <td>${productCode}</td>
                <td>${productName}</td>
                <td class="price">${productPrice.toFixed(2)}</td>
                <td><button class="decrease-btn">-</button></td>
                <td class="quantity">1</td>
                <td><button class="increase-btn">+</button></td>

                <td class="subtotal">${productPrice.toFixed(2)}</td>
                <td>
                    
                    
                    <button class="remove-btn">Eliminar</button>
                </td>
            `;
            cart.querySelector('tbody').appendChild(newRow);
        }
        updateTotal();
        calcularCambio();
    }

    function removeFromCart(productName) {
        var cart = document.getElementById('cart');
        var cartRow = cart.querySelector(`tbody tr[data-product="${productName}"]`);
        cartRow.remove();
        updateTotal();
        calcularCambio();
    }

    document.getElementById('cart').addEventListener('click', function(event) {
        if (event.target.classList.contains('remove-btn')) {
            var productName = event.target.parentNode.parentNode.getAttribute('data-product');
            removeFromCart(productName);
        } else if (event.target.classList.contains('increase-btn')) {
            var productName = event.target.parentNode.parentNode.getAttribute('data-product');
            updateCartQuantity('increase', productName);
        } else if (event.target.classList.contains('decrease-btn')) {
            var productName = event.target.parentNode.parentNode.getAttribute('data-product');
            updateCartQuantity('decrease', productName);
        }
    });

    function botonAñadirCarta(boton) {
        var row = boton.currentTarget.parentNode.parentNode;
        var productName = row.children[1].innerText;
        var productPrice = parseFloat(row.children[5].innerText);
        var productCode = row.children[2].innerText;
        addToCart(productName, productPrice, productCode);
    }

    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        button.addEventListener('click', handleAddToCartClick);
    });
        document.addEventListener("DOMContentLoaded", function() {
            const filterSelect = document.getElementById("filterSelect");
            const codigoTable = document.getElementById("codigoTable");
            const productoTable = document.getElementById("productoTable");
        
            filterSelect.addEventListener("change", function() {
                if (filterSelect.value === "codigo") {
                    codigoTable.classList.remove("hidden");
                    productoTable.classList.add("hidden");
                } else {
                    codigoTable.classList.add("hidden");
                    productoTable.classList.remove("hidden");
                }
            });
        });
        
        
    </script>



        
        
    
        
        
    
    
    
    <br><br>
        
        <!--<button onclick="DownFactura()"><i class="fa-solid fa-download"></i> Descargar Factura</button>
        <button onclick="DownTicket()"><i class="fa-solid fa-download"></i> Descargar Ticket </button>
        <br>-->
        
        <br>
        <!--<button onclick="DownTicket()">Vaciar cesta </button>-->
                </div>
            </div>
        </div>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/pdfmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/vfs_fonts.js"></script>
        <script>
        document.getElementById('searchInput').addEventListener('focus', function() {
    // Seleccionar todo el texto dentro del input
        this.select();
        });




        function genFactura() {
            var cartRows = document.getElementById('cart').querySelectorAll('tbody tr');
            
            // Calcular el total de la cesta
            var total = calcularTotal();
        
            // Datos de la empresa (modificar según tus datos)
            var empresa = {
                nombre: 'Empresa S.L.',
                nif: 'B12345678',
                telefono: '123456789',
                direccion: 'Calle Ejemplo, 123'
            };
            
            // Obtener datos del cliente desde el DOM
            var cliente = {
                nombre: document.getElementById('clientNomSelCrear').innerHTML,
                nif: document.getElementById('clientNifSelCrear').innerHTML,
                telefono: document.getElementById('clientTelSelCrear').innerHTML,
                direccion: document.getElementById('clientLocalSelCrear').innerHTML
            };
            
            // Datos de la tabla
            var tableBody = [];
            var baseTotal = 0;
            var ivaTotal = 0;
            
            cartRows.forEach(function(cartRow) {
                var productCode = cartRow.cells[0].innerText;
                var productName = cartRow.cells[1].innerText;
                var productPrice = parseFloat(cartRow.cells[2].innerText.replace('€', ''));
                var productQuantity = parseInt(cartRow.cells[4].innerText);
                var productTotal = parseFloat(cartRow.cells[6].innerText.replace('€', ''));
                
                // Calcular la base sin IVA y el IVA
                var baseSinIVA = (productTotal / 1.21).toFixed(2);
                var iva = (baseSinIVA * 0.21).toFixed(2);
                var totalLinea = (parseFloat(baseSinIVA) + parseFloat(iva)).toFixed(2);
        
                // Sumar al total base e IVA
                baseTotal += parseFloat(baseSinIVA) * productQuantity;
                ivaTotal += parseFloat(iva) * productQuantity;
        
                // Añadir a la tabla
                tableBody.push([
                    { text: productCode, alignment: 'left' },
                    { text: productName, alignment: 'left' },
                    { text: `${productQuantity}`, alignment: 'center' },
                    { text: `${baseSinIVA} €`, alignment: 'right' },
                    { text: `${iva} €`, alignment: 'right' },
                    { text: `${totalLinea} €`, alignment: 'right' }
                ]);
            });
        
            // Calcular el IVA total y el total con IVA
            var totalConIVA = (baseTotal + ivaTotal).toFixed(2);
            
            var docDefinition = {
                pageSize: 'A4',
                content: [
                    {
                        columns: [
                            {
                                width: '50%',
                                stack: [
                                    { text: empresa.nombre, style: 'header' },
                                    `NIF: ${empresa.nif}`,
                                    `Teléfono: ${empresa.telefono}`,
                                    `Dirección: ${empresa.direccion}`
                                ],
                                margin: [0, 20, 0, 0]
                            },
                            {
                                width: '50%',
                                stack: [
                                    { text: 'Cliente:', style: 'header' },
                                    `Nombre: ${cliente.nombre}`,
                                    `NIF: ${cliente.nif}`,
                                    `Teléfono: ${cliente.telefono}`,
                                    `Dirección: ${cliente.direccion}`
                                ],
                                alignment: 'right',
                                margin: [0, 20, 0, 0]
                            }
                        ],
                        columnGap: 20,
                        margin: [0, 0, 0, 20]
                    },
                    {
                        table: {
                            headerRows: 1,
                            widths: ['auto', '*', 'auto', 'auto', 'auto', 'auto'],
                            body: [
                                [
                                    { text: 'Código', bold: true },
                                    { text: 'Descripción', bold: true },
                                    { text: 'Cantidad', bold: true },
                                    { text: 'Base sin IVA', bold: true },
                                    { text: 'IVA (21%)', bold: true },
                                    { text: 'Total', bold: true }
                                ],
                                ...tableBody
                            ]
                        },
                        layout: 'lightHorizontalLines',
                        margin: [0, 30, 0, 20] // Margen inferior para dar espacio antes de la tabla de totales
                    },
                    {
                        table: {
                            widths: ['*', 'auto', 'auto'],
                            body: [
                                [
                                    { text: 'Total Base sin IVA:', bold: true },
                                    { text: `${baseTotal.toFixed(2)} €`, bold: true, alignment: 'right' },
                                    { text: '', margin: [10, 0, 0, 0] } // Espacio vacío
                                ],
                                [
                                    { text: 'Total IVA (21%):', bold: true },
                                    { text: `${ivaTotal.toFixed(2)} €`, bold: true, alignment: 'right' },
                                    { text: '', margin: [10, 0, 0, 0] } // Espacio vacío
                                ],
                                [
                                    { text: 'Total:', bold: true, fontSize: 16 },
                                    { text: `${totalConIVA} €`, bold: true, fontSize: 16, alignment: 'right' },
                                    { text: '', margin: [10, 0, 0, 0] } // Espacio vacío
                                ]
                            ]
                        },
                        layout: 'lightHorizontalLines',
                        margin: [0, 70, 0, 20] // Margen superior de 20 para separar de la tabla de productos, margen inferior de 60 para estar justo por encima del pie de página
                    }
                ],
                styles: {
                    header: { fontSize: 18, bold: true },
                    subheader: { fontSize: 14, bold: true, margin: [0, 15, 0, 0] },
                    footer: { fontSize: 10, italics: true, margin: [0, 0, 0, 0] }
                },
                // Posicionar el pie de página al final de la página
                footer: function(currentPage, pageCount, pageSize) {
                    return {
                        text: 'Este documento es una representación de la transacción y puede ser requerido por las autoridades fiscales. Por favor, conserve este documento como comprobante de la compra.',
                        style: 'footer',
                        alignment: 'center',
                        margin: [0, 0, 0, 0] // Asegura que el pie de página esté al final
                    };
                }
            };
            
            pdfMake.createPdf(docDefinition).print();
            enviarDatosFactura(totalConIVA);
            vaciarCesta();
        }
        
        
        
        
        
        
        
        
        
            
            
            
        function getFormattedDateTime() {
            var today = new Date();
            var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0');
            var yyyy = today.getFullYear();
            var hh = String(today.getHours()).padStart(2, '0');
            var min = String(today.getMinutes()).padStart(2, '0');
            var ss = String(today.getSeconds()).padStart(2, '0');

            return dd + '/' + mm + '/' + yyyy + ' -- ' + hh + 'h ' + min + 'min ' + ss+"s";
        }



            
        function DownFactura(){
            var dateTime = getFormattedDateTime();
            var fileName = "Factura " + document.getElementById('Name').value + " - "  +  getFormattedDateTime()   + ".pdf";

            var docDefinition = {
                pageSize: 'A4',
                content: [
                    { text: 'Empresa XYZ', style: 'header' },
                    { text: 'Nº de Factura: 12345', style: 'subheader' },
                    { text: 'Información del cliente:', style: 'subheader' },
                //{ text: document.getElementById('esc').value },
                    { text: 'Detalle de la factura:', style: 'subheader' },
                    { text: 'Producto 1 - Precio: $10' },
                    { text: 'Producto 2 - Precio: $15' },
                    { text: 'Producto 3 - Precio: $20' },
                    { text: 'Producto 4 - Precio: $25' },
                    { text: 'Producto 5 - Precio: $30' },
                    { text: 'Producto 6 - Precio: $35' },
                    { text: 'Producto 7 - Precio: $40' },
                    { text: 'Producto 8 - Precio: $45' },
                    { text: 'Producto 9 - Precio: $50' },
                    { text: 'Producto 10 - Precio: $55' }
                ],
                styles: {
                    header: { fontSize: 18, bold: true },
                    subheader: { fontSize: 14, bold: true, margin: [0, 15, 0, 0] }
                }
            };

            pdfMake.createPdf(docDefinition).download(fileName);
        }



            
            

            function DownTicket(){
                // Obtener productos del ticket
                var productos = [
                    { nombre: "Producto 1", precio: "$10" },
                    { nombre: "Producto 2", precio: "$15" },
                    { nombre: "Producto 3", precio: "$20" },
                    { nombre: "Producto 4", precio: "$25" },
                    { nombre: "Producto 5", precio: "$30" },
                    { nombre: "Producto 6", precio: "$35" },
                    { nombre: "Producto 7", precio: "$40" },
                    { nombre: "Producto 8", precio: "$45" },
                    { nombre: "Producto 9", precio: "$50" },
                    { nombre: "Producto 10", precio: "$55" }
                ];

                // Calcular altura de la página del ticket
                var height = 100 + (productos.length * 20); // 100 para el contenido fijo, 20 para cada línea de producto

                var docDefinition = {
                    pageSize: { width: 5 * 72, height: height }, // Definir tamaño de página en función de la cantidad de productos
                    content: [
                        { text: 'Ticket de Venta', style: 'header' },
                    ],
                    styles: {
                        header: { fontSize: 18, bold: true }
                    }
                };

                // Agregar cada producto al contenido del ticket
                productos.forEach(function(producto) {
                    docDefinition.content.push({ text: producto.nombre + " - Precio: " + producto.precio });
                });

                
                pdfMake.createPdf(docDefinition).download("ticket_venta.pdf"); // Descargar ticket de venta como PDF
            }
        
            function genTicket() {
                // Obtener elementos de la tabla de la cesta
                var cartRows = document.getElementById('cart').querySelectorAll('tbody tr');

                // Calcular el total de la cesta
                var total = calcularTotal();

                // Encabezado visual del ticket
                var docDefinition = {
                    pageSize: { width: 220, height: 'auto' }, // Ticket pequeño
                    pageMargins: [10, 10, 10, 10],
                    content: [
                        { text: 'TICKET DE VENTA', style: 'ticketHeader', alignment: 'center', margin: [0, 0, 0, 8] },
                        { text: getFormattedDateTime(), style: 'ticketDate', alignment: 'center', margin: [0, 0, 0, 8] },
                        {
                            table: {
                                headerRows: 1,
                                widths: [30, '*', 20, 20, 30],
                                body: [
                                    [
                                        { text: 'Cód.', style: 'ticketTableHeader', alignment: 'left' },
                                        { text: 'Producte', style: 'ticketTableHeader', alignment: 'left' },
                                        { text: 'Uds', style: 'ticketTableHeader', alignment: 'center' },
                                        { text: 'Preu', style: 'ticketTableHeader', alignment: 'right' },
                                        { text: 'Total', style: 'ticketTableHeader', alignment: 'right' }
                                    ]
                                ]
                            },
                            layout: 'lightHorizontalLines',
                            margin: [0, 0, 0, 8]
                        }
                    ],
                    styles: {
                        ticketHeader: { fontSize: 14, bold: true },
                        ticketDate: { fontSize: 8, italics: true },
                        ticketTableHeader: { fontSize: 8, bold: true },
                        ticketTableCell: { fontSize: 8 },
                        ticketTotal: { fontSize: 10, bold: true, alignment: 'right' }
                    }
                };

                // Agregar cada producto de la cesta a la tabla
                var tableBody = docDefinition.content[2].table.body;
                cartRows.forEach(function(cartRow) {
                    var productCode = cartRow.cells[0].innerText;
                    var productName = cartRow.cells[1].innerText;
                    var productPrice = cartRow.cells[2].innerText;
                    var productQuantity = cartRow.cells[4].innerText;
                    var productTotal = cartRow.cells[6].innerText;
                    tableBody.push([
                        { text: productCode, style: 'ticketTableCell', alignment: 'left' },
                        { text: productName, style: 'ticketTableCell', alignment: 'left' },
                        { text: productQuantity, style: 'ticketTableCell', alignment: 'center' },
                        { text: productPrice, style: 'ticketTableCell', alignment: 'right' },
                        { text: productTotal, style: 'ticketTableCell', alignment: 'right' }
                    ]);
                });

                // Línea separadora y total
                docDefinition.content.push(
                    { canvas: [ { type: 'line', x1: 0, y1: 0, x2: 200, y2: 0, lineWidth: 1 } ], margin: [0, 8, 0, 8] },
                    { text: `TOTAL: ${total} €`, style: 'ticketTotal', margin: [0, 0, 0, 8] },
                    { text: 'Gràcies per la seva compra!', alignment: 'center', fontSize: 9, margin: [0, 10, 0, 0] }
                );

                pdfMake.createPdf(docDefinition).print();

                enviarDatosTicket(total);
                vaciarCesta();
            }      
           
            
            function removeFromCartAndTicket(productName) {
                removeFromCart(productName); // Eliminar el producto de la cesta
            
                // Eliminar el producto de la variable cestaProductos
                cestaProductos = cestaProductos.filter(function(producto) {
                    return producto.nombre !== productName;
                });
            }
            
            function calcularTotal() {
                var total = 0;
                var cartRows = document.getElementById('cart').querySelectorAll('tbody tr');
            
                cartRows.forEach(function(cartRow) {
                    // price está en la celda 2, quantity en la celda 4
                    var price = parseFloat(cartRow.cells[2].innerText);
                    var quantity = parseInt(cartRow.cells[4].innerText);
                    total += price * quantity;
                });
            
                return total.toFixed(2); // Redondear el total a dos decimales
            }







            function vaciarCesta() {
                // Obtener el tbody de la tabla
                var tbody = document.querySelector('#cart tbody');
                // Vaciar el contenido del tbody
                tbody.innerHTML = '';
                document.getElementById('total').textContent = '0.00';
                //location.reload();
            }

            function genTicketYEnviar() {
                genTicket();
            
            }
            
            function enviarDatosFactura(totalText) {
            
                console.log("Total:", totalText); // Log the total value
                var csrftoken = getCookie('csrftoken');  // Function to retrieve the CSRF token from cookies
                var numCliElement = document.getElementById("clientIdSelCrear");

            // Obtenemos el contenido de texto del <span> y lo convertimos a número
                var num_Cli = parseInt(numCliElement.textContent, 10);
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/guardar_factura/", true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('X-CSRFToken', csrftoken); // Include the CSRF token in the request header
                xhr.onload = function () {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        console.log("Respuesta del servidor:", xhr.responseText);
                        // Recargar la ventana después de guardar la factura
                        window.location.reload();
                    } else {
                        console.error("Error en la solicitud:", xhr.statusText);
                    }
                };
                xhr.onerror = function () {
                    console.error("Error de red al enviar la solicitud.");
                };
                xhr.send(JSON.stringify({num_Cli: num_Cli,totalText:totalText }));
            enviarDatosProductosFactura();
                
                
            }
            function enviarDatosTicket(totalText) {
                var checkboxs = document.querySelectorAll('input[name="pagament"]');

                // Recorre los checkboxes para encontrar el que está marcado
                        var pagament = null;
                        checkboxs.forEach(function(element) {
                            if (element.checked) {
                                pagament = element.value;
                            }
                        });

                        
                console.log("Total:", totalText); // Log the total value
                var csrftoken = getCookie('csrftoken');  // Function to retrieve the CSRF token from cookies
                
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/guardar_ticket/", true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('X-CSRFToken', csrftoken); // Include the CSRF token in the request header
                xhr.onload = function () {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        console.log("Respuesta del servidor:", xhr.responseText);
                    } else {
                        console.error("Error en la solicitud:", xhr.statusText);
                    }
                };
                xhr.onerror = function () {
                    console.error("Error de red al enviar la solicitud.");
                };
                xhr.send(JSON.stringify({ total: totalText,pagament:pagament }));
                
                enviarDatosProductosTicket();
                
            }
            
            // Function to retrieve the CSRF token from cookies
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            
        </script>
        <script>
            function enviarDatosProductosTicket() {

                


                var csrftoken = getCookie('csrftoken'); // Obtener el token CSRF
        
                var productos = [];
                var rows = document.getElementById('cart').getElementsByTagName('tbody')[0].getElementsByTagName('tr');
                for (var i = 0; i < rows.length; i++) {
                    var codigo = rows[i].getElementsByTagName('td')[0].innerText;
                    var cantidad = rows[i].getElementsByTagName('td')[4].innerText;
                    productos.push({codigo: codigo, cantidad: cantidad});
                }
                console.log(productos);

                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/guardar_productos_ticket/", true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('X-CSRFToken', csrftoken);
                xhr.onload = function () {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        console.log("Respuesta del servidor:", xhr.responseText);
                    } else {
                        console.error("Error en la solicitud:", xhr.statusText);
                    }
                };
                xhr.onerror = function () {
                    console.error("Error de red al enviar la solicitud.");
                };
                xhr.send(JSON.stringify({ productos: productos }));
            }
            function enviarDatosProductosFactura() {
                var csrftoken = getCookie('csrftoken'); // Obtener el token CSRF
        
                var productos = [];
                var rows = document.getElementById('cart').getElementsByTagName('tbody')[0].getElementsByTagName('tr');
                for (var i = 0; i < rows.length; i++) {
                    var codigo = rows[i].getElementsByTagName('td')[0].innerText;
                    var cantidad = rows[i].getElementsByTagName('td')[4].innerText;
                    productos.push({codigo: codigo, cantidad: cantidad});
                }
                console.log(productos);

                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/guardar_productos_factura/", true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('X-CSRFToken', csrftoken);
                xhr.onload = function () {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        console.log("Respuesta del servidor:", xhr.responseText);
                    } else {
                        console.error("Error en la solicitud:", xhr.statusText);
                    }
                };
                xhr.onerror = function () {
                    console.error("Error de red al enviar la solicitud.");
                };
                xhr.send(JSON.stringify({ productos: productos }));
            }
    // La función para obtener la cookie CSRF sigue siendo la misma
        
            
        </script>
    </body>
    </html>
    {% endblock %}