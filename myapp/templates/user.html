{% extends "layouts/base.html" %}


{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda</title>
    
    <script src="https://kit.fontawesome.com/8e16281abb.js" crossorigin="anonymous"></script>
</head>
<body>
    {{user.is_authenticated}}
    <div class="main-content">
        <h1>Perfil de {{ user.username }}</h1>
        <p>Email: {{ user.email }}</p>
        <p>Fecha de creaci√≥n: {{ user.date_joined }}</p>
        <p>Es admin?: {{user.is_staff}} </p>
        {% if user.is_staff %}
        <div>
            <form method="POST">
        <h1 id="h1-crear-signup">CREAR</h1>
        {% csrf_token %}
        <section id="form_signup">
            
        <div class="input-group">
            <i class="fas fa-user"></i>
            {{ form.username }}
        </div>
        {% if form.username.errors %}
            <div class="error-text">{{ form.username.errors.0 }}</div>
        {% endif %}

        <div class="input-group">
            <i class="fas fa-lock"></i>
            {{ form.password1 }}
        </div>
        {% if form.password1.errors %}
            <div class="error-text">{{ form.password1.errors.0 }}</div>
        {% endif %}

        <div class="input-group">
            <i class="fas fa-lock"></i>
            {{ form.password2 }}
        </div>
        {% if form.password2.errors %}
            <div class="error-text">{{ form.password2.errors.0 }}</div>
        {% endif %}




        <div class="input-group">
            <i class="fas fa-user"></i>
            {{ form.email }}
        </div>
        {% if form.email.errors %}
            <div class="error-text">{{ form.email.errors.0 }}</div>
        {% endif %}

       

        <button id="btn-crear-compte">Crear i connectar</button>
        <button>Confirmar amb mail</button>

        {{ error }}

        <p><a href="#">Contrasenya oblidada</a> o <a href="/login/">Ja tens compte?</a></p>
    </section>
</form>
    <table>
        <tbody>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Fecha de creaci√≥n</th>
                <th>Es admin?</th>
                <th>Esta activo?</th>
                <th>Acciones</th>
            </tr>
            {% for user in users %}
            <tr>
                <td>{{ user.username }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.date_joined }}</td>
                <td>{{ user.is_staff }}</td>
                <td>{{ user.is_active }}</td>
                <td><button onclick="mostrar_popup_user('{{ user.username }}', '{{ user.email }}', '{{ user.is_staff }}','{{ user.is_active }}')">Modificar</button></td>
            </tr>
            {% endfor %}
    
    </table>
<script>
    function mostrar_popup_user(username,email,is_staff,is_active) {
        document.getElementById('popup-user').style.display = 'block';
        document.querySelector('#popup-user input[name="username"]').value = username;
        document.querySelector('#popup-user input[name="username_real"]').value = username;
        document.querySelector('#popup-user #nom_user').textContent = username;
        document.querySelector('#popup-user input[name="email"]').value = email;
        console.log(is_staff, is_active);
    

        if (is_staff === 'True') {
            document.querySelector('#popup-user input[name="is_staff"]').checked = true;
        }
        if (is_active === 'True') {
            document.querySelector('#popup-user input[name="is_active"]').checked = true;
        }

        
    }

    function recargar_pagina() {
        window.location.reload();
    }


</script>

    
        <div class="popup hidden"  id="popup-user">
            <div class="popup-content">
                <span class="close" onclick="document.getElementById('popup-user').style.display='none'">&times;</span>
               
             
                    {% csrf_token %}
                    <h1> MODIFICAR USER <span id="nom_user"></span></h1>
                    <input type="hidden" name="username_real" >
                    <input type="text" name="username" placeholder="Nuevo nombre de usuario" required>
                    <input type="email" name="email" placeholder="Nuevo email" required>
                    
                    <input type="password" name="password" placeholder="Nueva contrase√±a">
                    <input type="password" name="confirm_password" placeholder="Confirmar contrase√±a">
                    <input type="checkbox" name="is_staff" > Es admin?
                    <input type="checkbox" name="is_active" > Est√° activo?

                    <button onclick="guardar_cambios()" type="button">Guardar Cambios</button>

            </div>
            <button class="close" onclick="document.getElementById('popup-user').style.display='none'">&times;</button>
        </div>
   

</div>
         {% endif %}
      
       <script>
        
  
function guardar_cambios() {
  // 1Ô∏è‚É£ Capturamos el <form>, no el div
  const form = document.getElementById('popup-user');

  // 2Ô∏è‚É£ Sacamos valores de los inputs dentro del form
  const username     = form.querySelector('input[name="username"]').value;
  const usernameReal = form.querySelector('input[name="username_real"]').value;
  const email        = form.querySelector('input[name="email"]').value;
  const password     = form.querySelector('input[name="password"]').value;
  const confirmPass  = form.querySelector('input[name="confirm_password"]').value;
  const isStaff      = form.querySelector('input[name="is_staff"]').checked;
  const isActive     = form.querySelector('input[name="is_active"]').checked;
  const csrfToken    = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
console.log("Datos a enviar:", {
    username,
    usernameReal,
    email,
    password,
    confirmPass,
    isStaff,
    isActive
  });
  // 3Ô∏è‚É£ Enviamos JSON con el header correcto
  fetch("{% url 'update_user' %}",  {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrfToken
    },
    body: JSON.stringify({
      username:         username,
      username_real:    usernameReal,
      email:            email,
      password:         password,
      confirm_password: confirmPass,
      is_staff:         isStaff,
      is_active:        isActive
    })
  })
  .then(response => {
    if (response.status === 204) {
      // üîÑ recarga solo tras √©xito
      window.location.reload();
    } else {
      console.error("Error al actualizar:", response.status);
    }
  })
  .catch(err => console.error("Fetch error:", err));
}

    

</script>
        <h1>Mi Google Calendar</h1>

<iframe src="https://calendar.google.com/calendar/embed?src=abc123%40group.calendar.google.com&ctz=America%2FNew_York" style="border: 0" width="100%" height="600" frameborder="0" scrolling="no"></iframe>

        <div>
        {% if user.is_authenticated %}
            <a href="/logout/">Cerrar sesi√≥n</a>
        {% else %}
            <a href="/login/">Iniciar sesi√≥n</a>
        {% endif %}
        </div>
    </div>

</body>
</html>
        {% endblock %}