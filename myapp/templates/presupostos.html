
{% extends "layouts/base.html" %}

{% load static %}
{% block content %}
 
     <script src="{% static 'js/pressupostos.js' %}"></script>

    <script src="https://kit.fontawesome.com/8e16281abb.js" crossorigin="anonymous"></script>

<div class="main-content">
    <div id="popup" class="popup-container" >
        <div class="popup-content">
            <!-- The content will be inserted here by JavaScript -->
        </div>
    </div>
    <div class="products-section">
        <h1>PRESUPOSTOS</h1>
<p>(es pot eliminar, descarregar, reembolsar, veure datos, enviar per mail?)</p>


             <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
  <form method="get" style="display: flex; align-items: center; gap: 10px; margin: 0;">
    <label for="data-inicio">De:</label>
    <input type="date" id="data-inicio" name="data_inicio" value="{{ data_inicio }}">
    <label for="data-fin">A:</label>
    <input type="date" id="data-fin" name="data_fi" value="{{ data_fi }}">
    <input type="text" name="search" value="{{ search }}" placeholder="Buscar persona...">
    <button type="submit" class="blue-button">üîç</button>
  </form>

  <form method="get" style="margin: 0; margin-left: 10px;">
    <button type="submit" class="blue-button">üîÑ</button>
  </form>
</div>


<button id="afegir-reparacio-btn">Afegir Presupost</button>


    </div>
    <form method="post">
        <table id="productTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>FECHA</th>
               <th>Client</th>
                
                <th>Total</th>
                <th>VEURE</th>
            </tr>
            </thead>
            <tbody>
            {% for pressupost in pressupostos %}
            <tr class="filaTicket">
                <td>{{ pressupost.id }}</td>
               <td>{{ pressupost.date|date:"d/m/Y H:i" }}</td>

                <td>{{ pressupost.persona_id }} </td>
                <td>{{ pressupost.total }} </td>
                 <!-- A IMPLEMENTAR A MODELS, VIEWS...
                <td>{{ factura.total }} ‚Ç¨</td>-->
              
                <td><button type="button" class="popup-trigger" onclick="mostrarPressupost({{ pressupost.id }})" ><i
                        class="fa-regular fa-pen-to-square"></i></button></td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        <div style="text-align: center; margin-top: 2rem;">
  {% if pressupostos.has_previous %}
    <a href="?page={{ pressupostos.previous_page_number }}" class="blue-button">‚¨ÖÔ∏è Anteriors</a>
  {% endif %}

  <span style="margin: 0 1rem; font-weight: bold;">
    P√†gina {{ pressupostos.number }} de {{ pressupostos.paginator.num_pages }}
  </span>

  {% if pressupostos.has_next %}
    <a href="?page={{ pressupostos.next_page_number }}" class="blue-button">‚û°Ô∏è Seg√ºents</a>
  {% endif %}
</div>  
    
    </form>
<div id="modal-overlay" class="hidden">
    <div id="modal-panel">
        <div class="clientPressupost">
        <h2>Afegir Pressupost</h2>
        <button onclick="showOverlay()">Afegir client</button>
       
        <span id="clientIdSelCrear" >aa</span>
        <span id="clientNomSelCrear"></span>
        <span id="clientNifSelCrear"></span>
        <span id="clientTelSelCrear"></span>
        <span id="clientLocalSelCrear"></span>
        
        </div>
        <div class="inputDESCRIPCIO">
        <label>INFO ADICIONAL<br></label>
        <textarea  id="DescripcioPressupost" placeholder="MA D'OBRA: CANVI DE PANTALA..."></textarea>
        </div>
        <div style="text-align:left;">
        <button onclick="showBuscar_productos()">+</button>
        </div>
        <table class="taula-productes-pressupost" id="taula-crear">
        <thead>
            <tr>
                <th>ID</th>
                <th>NOM</th>
                <th>QUNATITAT</th>
                <th>PREU</th>
                <th>total</th>
                <th>IMATGE</th>
                <th>BORRAR</th>
            </tr>
        </thead>
        <tbody>
            
           
        </tbody>
        <tfoot >
            <tr>
                <td style="background:white;"></td>
                <td style="background:white;"></td>
                <td></td>
                <td>Productes: <span id="sumQuantitat"></span></td>
                <td style="background:white;">Total: <span class="sumTotal">0</span></td>

            </tr>
        
        </tfoot>
        </table>
        <button id="close-modal-btn">Cerrar</button>
        <button onclick="CrearNouPresupost()">Crearr</button>

    </div>
</div>





        </div>
    </div>
</div>
<script>
   
                
</script>


    
</div>
</div>
<script>



function mostrarPressupost(pressupostId) {
    const popup = document.getElementById('popup');

    fetch(`/obtenir_pressupost/${pressupostId}/`)
        .then(response => response.json())
        .then(data => {
            localStorage.setItem(`pressupost-${data.id}`, JSON.stringify(data));
            const dateObj = new Date(data.date);
            const formattedDate = `${dateObj.getDate()}-${dateObj.getMonth() + 1}-${dateObj.getFullYear()}`;
            const time = `${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')}`;

            let rows = data.productos.map(p => `
                <tr class="linea_productes_pressupost_${p.id} linea_productes_pressupost_edit">
                    <td id="producte_id_pressupost">${p.producto_id}</td>
                    <td>${p.nombre}</td>
                    <td><input class="producte-input-quantitat" id="quantitat_${p.producto_id}" value="${p.cantidad}"></td>
                    <td><span class="producte-preu-unitat">${p.preu}</span> ‚Ç¨</td>
                    <td><span class="producte-preu-total">${(p.preu * p.cantidad).toFixed(2)}</span> ‚Ç¨</td>
                    <td><img style="max-height:30px;" src="${p.producto_imagen}"></td>
                    <td><button onclick="esborrarDePressupost('${p.id}', '${data.id}')">BORRAR</button></td>
                </tr>
            `).join('');

            popup.innerHTML = `
                <div class="popup-content">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div>
                            <h2>PRESSUPOST n√∫m. ${data.id}</h2>
                            <p><strong>Data:</strong> ${formattedDate} - <strong>Hora:</strong> ${time}</p>
                            <p>${data.facturat ? 'Facturat: ' + data.facturat : ''}</p>
                        </div>
                        <div>
                            <button onclick="showOverlay()">Cambiar client</button>
                            <span id="clientIdSelEdit" >${data.persona_id}</span>
        <span id="clientNomSelEdit">|${data.persona_nom}</span>
        <span id="clientNifSelEdit">|${data.persona_nif}</span>
        <span id="clientTelSelEdit">|${data.persona_tel}</span>
        <span id="clientEmailSelEdit">${data.persona_email}</span>
                        </div>
                    </div>

                    <label for="paymentMethod">M√®tode de pagament:</label>
                    <select id="paymentMethod">
                        <option value="Tarjeta" ${data.metodo_pago === 'Tarjeta' ? 'selected' : ''}>Targeta</option>
                        <option value="Efectivo" ${data.metodo_pago === 'Efectivo' ? 'selected' : ''}>Efectiu</option>
                    </select>

                    <div>
                        <textarea id="notaPressupostEdit" rows="2" cols="30">${data.nota}</textarea>
                    </div>

                    <button onclick="showOverlay3()">Afegir producte</button>

                    <table class="taula-productes-pressupost" id="taula-editar">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom</th>
                                <th>Quantitat</th>
                                <th>Preu</th>
                                <th>Total</th>
                                <th>Imatge</th>
                                <th>Acci√≥</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4">Total:</td>
                                <td colspan="3"><span class="sumTotal total-editar">${data.total}</span> ‚Ç¨</td>
                            </tr>
                        </tfoot>
                    </table>

                    <div class="popup-buttons">
                        <button onclick="genPressupost()" class="blue-button">Descarregar</button>
                        <button class="red-button">Eliminar</button>
                        <button onclick="facturarPressupost(${data.id})" class="yellow-button">Facturar</button>
                        <button onclick="aplicarPressupost(${data.id})" class="green-button">Aplicar</button>
                        <button onclick="mostrarEditorEmail(${data.id})">Enviar per mail</button>
                        <button class="close-popup">Tancar</button>
                    </div>
                </div>
            `;

            // Attach event listeners to quantity inputs
            popup.querySelectorAll('.producte-input-quantitat').forEach(input => {
                input.addEventListener('input', function() {
                    const row = this.closest('tr');
                    const price = parseFloat(row.querySelector('.producte-preu-unitat').textContent);
                    const quantity = parseFloat(this.value) || 0;
                    const totalElement = row.querySelector('.producte-preu-total');
                    totalElement.textContent = (price * quantity).toFixed(2);
                    
                    // Update grand total
                    let grandTotal = 0;
                    popup.querySelectorAll('.producte-preu-total').forEach(total => {
                        grandTotal += parseFloat(total.textContent);
                    });
                    popup.querySelector('.sumTotal').textContent = grandTotal.toFixed(2);
                });
            });

            popup.style.display = 'flex';
            popup.querySelector('.close-popup').addEventListener('click', () => {
                popup.style.display = 'none';
            });
        })
        .catch(error => console.error('Error carregant el pressupost:', error));
}
   
function mostrarEditorEmail(pressupostId) {
  let clientIdSelEdit = document.getElementById('clientIdSelEdit').textContent;
  let clientNomSelEdit = document.getElementById('clientNomSelEdit').textContent
  let clientNifSelEdit = document.getElementById('clientNifSelEdit').textContent;
  let clientTelSelEdit = document.getElementById('clientTelSelEdit').textContent;
  let clientEmailSelEdit = document.getElementById('clientEmailSelEdit').textContent;

  const pressupostData = JSON.parse(localStorage.getItem(`pressupost-${pressupostId}`));
  if (!pressupostData) return alert("Pressupost no trobada");

  const popup = document.getElementById('popup');
  const container = popup.querySelector('.popup-content');

  const textarea = document.createElement('textarea');
  textarea.id = 'email-message';
  textarea.placeholder = 'Missatge que s‚Äôenviar√† per correu...';
  textarea.style.width = '100%';
  textarea.style.minHeight = '100px';
  textarea.style.marginTop = '1rem';
  textarea.value = `Hola ${clientNomSelEdit},\n\nEt fem arribar adjunta la pressupost n√∫m. ${pressupostData.id}.\n\nSalutacions.`;

  const btn = document.createElement('button');
  btn.textContent = '‚úâÔ∏è Enviar correu';
  btn.className = 'blue-button';
  btn.style.marginTop = '1rem';

  btn.onclick = () => {
    aplicarPressupost(pressupostId)
    const missatge = textarea.value;

    // üîÅ Generar el mateix PDF que a `genFactura()`
    const dateObj = new Date(pressupostData.date);
    const formattedDate = `${dateObj.getDate()}/${dateObj.getMonth() + 1}/${dateObj.getFullYear()}`;
    const time = `${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')}`;

    const docDefinition = {
      content: [
        { text: `Pressupost n√∫m. ${pressupostData.id}`, style: 'header' },
        { text: `Data: ${formattedDate} - Hora: ${time}`, style: 'subheader' },
        { text: `Client: ${clientIdSelEdit} (ID: ${pressupostData.persona_id})`, style: 'subheader' },
        { text: `Tel√®fon: ${clientTelSelEdit}`, style: 'subheader' },
        { text: `Email: ${clientEmailSelEdit}`, style: 'subheader' },
        { text: `NIF: ${clientNifSelEdit}`, style: 'subheader' },
        { text: `Nota: ${pressupostData.nota}`, style: 'subheader' },
        { text: `\n`, style: 'subheader' },
        { text: `M√®tode de pagament: ${pressupostData.metodo_pago}`, style: 'subheader' },
        { text: '\n' },
        {
          table: {
            headerRows: 1,
            widths: ['auto', '*', 'auto', 'auto', 'auto'],
            body: [
              ['ID', 'Nom', 'Quantitat', 'Preu', 'Total'],
              ...pressupostData.productos.map(p => [
                p.producto_id,
                p.nombre,
                p.cantidad,
                `${p.preu} ‚Ç¨`,
                `${(p.preu * p.cantidad).toFixed(2)} ‚Ç¨`
              ])
            ]
          }
        },
        { text: '\n' },
        { text: `Total factura: ${pressupostData.total} ‚Ç¨`, style: 'total' }
      ],
      styles: {
        header: { fontSize: 18, bold: true, alignment: 'center', margin: [0, 0, 0, 10] },
        subheader: { fontSize: 12, margin: [0, 2, 0, 2] },
        total: { fontSize: 14, bold: true, alignment: 'right', margin: [0, 10, 0, 0] }
      }
    };

    pdfMake.createPdf(docDefinition).getDataUrl(pdfBase64 => {
      fetch('/enviar_pressupost_email/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({
          pressupost: pressupostData,
           
          
            clientEmail: clientEmailSelEdit,
          missatge: missatge,
          pdf: pdfBase64
        })
      })
      .then(res => res.json())
      .then(data => {
        alert('Correu enviat correctament!');
        popup.style.display = 'none';
      })
      .catch(err => {
        console.error('Error al enviar:', err);
        alert('Error enviant el correu.');
      });
    });
  };

  container.appendChild(textarea);
  container.appendChild(btn);
}


    

</script>

<script>


</script>

        
    </div>
    
    
</div>
   {% include "buscar_cliente.html" %}
     {% include "buscar_producto.html" %}


{% endblock %}